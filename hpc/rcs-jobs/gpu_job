#PBS -lselect=1:ncpus=4:mem=24gb:ngpus=1:gpu_type=RTX6000

#PBS -lwalltime=24:0:0

#PBS -J 1-10

# Setup environement using .bashrc
source $HOME/.bashrc

# Clone repository and checkout to the given tag name.
git clone git@github.com:A-Alaa/ICE-NODE.git $TMPDIR/ICE-NODE --branch $STUDY_TAG --single-branch  --depth 1 

cd $TMPDIR/ICE-NODE

$HOME/anaconda3/condabin/conda activate $HOME/GP/env/icenode-env

# Load modules
module load cudnn/8.2.4
module load cuda/11.4.2

# Input data and output configuration
OUTPUT_DIR=""
DATA_DIR=""

if [[ "$DATA_TAG" == "M3" ]]; then
  OUTPUT_DIR="$HOME/GP/ehr-data/icenode-m3-exp"
  DATA_DIR="$HOME/GP/ehr-data/mimic3-transforms"
else
  OUTPUT_DIR="$HOME/GP/ehr-data/icenode-m4-exp"
  DATA_DIR="$HOME/GP/ehr-data/mimic4-transforms"
fi




# Run program

export JAX_PLATFORM_NAME=gpu

$HOME/GP/env/icenode-env/bin/python -m icenode.hyperopt.optuna_multi \
--output-dir $OUTPUT_DIR \
--mimic-processed-dir $DATA_DIR \
--study-tag $STUDY_TAG \
--data-tag $DATA_TAG \
--emb $EMB \
--model $MODEL \
--optuna-store $OPTUNA_STORE \
--mlflow-store $MLFLOW_STORE \
--trials-time-limit 24 \
-N 1 \
--num-trials 30 \
--training-time-limit 12 \
--job-id "$PBS_JOBID $PBS_ARRAY_INDEX"


mkdir $PBS_O_WORKDIR/$PBS_JOBID
cp * $PBS_O_WORKDIR/$PBS_JOBID

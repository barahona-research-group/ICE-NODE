#PBS -lselect=1:ncpus=4:mem=24gb:ngpus=1:gpu_type=RTX6000

#PBS -lwalltime=24:0:0

#PBS -J 1-50

# Load GPU modeuls
module load cuda/11.4.2
module load cudnn/8.2.4

# Setup environement using .bashrc
source $HOME/.bashrc
$HOME/anaconda3/condabin/conda activate mimicnet

# Clone repository and checkout to the given tag name.
git clone git@github.com:A-Alaa/MIMIC-SNONET.git $TMPDIR/MIMIC-SNONET --branch $STUDY_TAG --single-branch 

cd $TMPDIR/MIMIC-SNONET

# Load modules for any applications

# Run program
$HOME/anaconda3/envs/mimicnet/bin/python -m mimicnet.hpo_multi \
--output-dir $HOME/GP/ehr-data/mimicnet-experiments/${STUDY_TAG}_${MODEL} \
--mimic-processed-dir ~/GP/ehr-data/mimic3-transforms \
--study-tag $STUDY_TAG \
--model $MODEL \
--optuna-store $OPTUNA_STORE \
--mlflow-store $MLFLOW_STORE \
--num-trials 5 \
-N 1 \
--job-id "$PBS_JOBID $PBS_ARRAY_INDEX" 

mkdir $PBS_O_WORKDIR/$PBS_JOBID
cp ./* $PBS_O_WORKDIR/$PBS_JOBID -r

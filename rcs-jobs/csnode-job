#PBS -lselect=1:ncpus=48:mem=124gb

#PBS -lwalltime=24:0:0

# Setup environement using .bashrc
source $HOME/.bashrc
$HOME/anaconda3/condabin/conda activate mimicnet

# Clone repository and checkout to the given tag name.
git clone git@github.com:A-Alaa/MIMIC-SNONET.git $TMPDIR/MIMIC-SNONET --branch $STUDY_TAG --single-branch 

cd $TMPDIR/MIMIC-SNONET

# Load modules for any applications

# Run program

OUTPUT_DIR=""
DATA_DIR=""

if [[ "$DATA_TAG" == "M3" ]]; then
  OUTPUT_DIR="$HOME/GP/ehr-data/mimicnet-m3-exp"
  DATA_DIR="$HOME/GP/ehr-data/mimic3-transforms"
else
  OUTPUT_DIR="$HOME/GP/ehr-data/mimicnet-m4-exp"
  DATA_DIR="$HOME/GP/ehr-data/mimic4-transforms"
fi

$HOME/anaconda3/envs/mimicnet/bin/python -m mimicnet.train_config \
--config $CONFIG \
--config-tag $CONFIG_TAG \
--output-dir $OUTPUT_DIR \
--mimic-processed-dir $DATA_DIR \
--data-tag $DATA_TAG \
--model $MODEL \
--cpu 

mkdir $PBS_O_WORKDIR/$PBS_JOBID
cp * $PBS_O_WORKDIR/$PBS_JOBID
